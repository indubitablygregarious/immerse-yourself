name: Windows Smoke Test

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release tag to test (e.g., v0.3.24). Leave empty for latest.'
        required: false
        type: string

jobs:
  smoke-test:
    runs-on: windows-latest
    permissions:
      contents: read
    steps:
      - name: Determine version
        id: version
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -n "${{ inputs.version }}" ]; then
            echo "tag=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            TAG=$(gh release view --repo ${{ github.repository }} --json tagName -q .tagName)
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          fi
          echo "Testing version: $(cat $GITHUB_OUTPUT | grep tag= | cut -d= -f2)"

      - name: Download Windows release
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release download "${{ steps.version.outputs.tag }}" \
            --repo ${{ github.repository }} \
            --pattern "*windows*.zip"

      - name: Extract archive
        shell: pwsh
        run: |
          Expand-Archive -Path "immerse-yourself-windows-x86_64.zip" -DestinationPath "app"
          Get-ChildItem -Recurse app/ | Select-Object FullName

      - name: Check WebView2 Runtime
        shell: pwsh
        run: |
          $regPath = "HKLM:\SOFTWARE\WOW6432Node\Microsoft\EdgeUpdate\Clients\{F3017226-FE2A-4295-8BEB-13D150CA6D0C}"
          if (Test-Path $regPath) {
            $ver = (Get-ItemProperty $regPath).pv
            Write-Host "WebView2 Runtime found: $ver"
          } else {
            Write-Host "WebView2 not found, installing..."
            choco install webview2-runtime -y
          }

      - name: Launch application
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path "app" -Filter "immerse-yourself.exe" -Recurse | Select-Object -First 1
          Write-Host "Launching: $($exe.FullName)"
          $proc = Start-Process -FilePath $exe.FullName -WorkingDirectory $exe.DirectoryName -PassThru
          echo "SMOKE_PID=$($proc.Id)" >> $env:GITHUB_ENV
          Write-Host "Started PID: $($proc.Id)"

      - name: Wait for startup
        shell: pwsh
        run: Start-Sleep -Seconds 15

      - name: Verify process is alive
        shell: pwsh
        run: |
          $proc = Get-Process -Id $env:SMOKE_PID -ErrorAction SilentlyContinue
          if ($proc) {
            Write-Host "PASS: Process $($env:SMOKE_PID) is running"
            Write-Host "  Name: $($proc.ProcessName)"
            Write-Host "  Memory: $([math]::Round($proc.WorkingSet64 / 1MB, 1)) MB"
            Write-Host "  Handles: $($proc.HandleCount)"
          } else {
            Write-Host "FAIL: Process $($env:SMOKE_PID) has exited"
            exit 1
          }

      - name: Capture screenshot
        shell: pwsh
        run: |
          Add-Type -AssemblyName System.Windows.Forms
          Add-Type -AssemblyName System.Drawing
          $screen = [System.Windows.Forms.Screen]::PrimaryScreen.Bounds
          $bitmap = New-Object System.Drawing.Bitmap($screen.Width, $screen.Height)
          $graphics = [System.Drawing.Graphics]::FromImage($bitmap)
          $graphics.CopyFromScreen($screen.Location, [System.Drawing.Point]::Empty, $screen.Size)
          $bitmap.Save("windows-smoke-test.png")
          $graphics.Dispose()
          $bitmap.Dispose()
          Write-Host "Screenshot saved: windows-smoke-test.png"

      - name: Stop application
        shell: pwsh
        if: always()
        run: |
          if ($env:SMOKE_PID) {
            Stop-Process -Id $env:SMOKE_PID -Force -ErrorAction SilentlyContinue
            Write-Host "Stopped process $($env:SMOKE_PID)"
          }

      - name: Upload screenshot
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: windows-smoke-test-${{ steps.version.outputs.tag }}
          path: windows-smoke-test.png
          retention-days: 30
